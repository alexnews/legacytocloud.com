# Session Log - December 22, 2025

## What Happened
User restored project from GitHub after losing local files. Needed to redeploy to production Ubuntu 22.04 server.

## What We Did

### 1. Created deploy.sh
Script for Ubuntu 22.04 production server at `/usr/local/www/legacytocloud.com/deploy.sh`:
- Installs backend Python dependencies
- Runs alembic migrations
- Builds frontend with production URL
- Copies to www folder
- Restarts systemd service

### 2. Fixed alembic.ini
**Problem:** alembic.ini had hardcoded `postgres:postgres` credentials
**Fix:** Updated `backend/alembic/env.py` to load `.env` file using dotenv:
```python
from dotenv import load_dotenv
load_dotenv(os.path.join(..., ".env"))
```

### 3. Created PostgreSQL database
```sql
CREATE DATABASE legacytocloud;
CREATE USER ltc_user WITH PASSWORD 'Test000!';
GRANT ALL PRIVILEGES ON DATABASE legacytocloud TO ltc_user;
```

### 4. Fixed Apache config
Added API proxy to `config/apache/legacytocloud-prod.conf`:
```apache
ProxyPreserveHost On
ProxyPass /api http://127.0.0.1:8003/api
ProxyPassReverse /api http://127.0.0.1:8003/api
```

### 5. Installed systemd service
```bash
sudo cp config/systemd/legacytocloud-api.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable legacytocloud-api
sudo systemctl start legacytocloud-api
```

### 6. Added signup form features
Updated `frontend/src/app/register/page.tsx`:
- Password confirmation field
- "I am not a robot" JavaScript checkbox

### 7. Created documentation
Created `steps/start.md` with project context for AI agents.

---

## Issue (RESOLVED)

**Problem:** Frontend showed "Failed to fetch" with `ERR_CERT_COMMON_NAME_INVALID`

**Solution:** Rebuilt frontend twice + hard browser refresh. Likely browser cache issue.

```bash
cd /usr/local/www/legacytocloud.com/frontend
STATIC_EXPORT=true NEXT_PUBLIC_API_URL=https://www.legacytocloud.com/api npm run build
cp -r out/* /usr/local/www/legacytocloud.com/www/
# Then Ctrl+Shift+R in browser
```

---

## Server Details
- **OS:** Ubuntu 22.04
- **Path:** `/usr/local/www/legacytocloud.com/`
- **User:** dundee (for development), www-data (for production)
- **Database:** PostgreSQL 14, database `legacytocloud`, user `ltc_user`
- **Backend:** FastAPI on port 8003 via systemd
- **Frontend:** Static HTML served by Apache

## Files Modified Today
- `deploy.sh` - created
- `steps/start.md` - created
- `backend/alembic/env.py` - added dotenv loading
- `backend/alembic.ini` - added comment about .env override
- `config/apache/legacytocloud-prod.conf` - synced with server
- `frontend/src/app/register/page.tsx` - added confirm password + robot check
